<section class="tree">
  <cdk-virtual-scroll-viewport [itemSize]="treeItemSizePx" class="viewport" #viewPort>
    <ng-container *cdkVirtualFor="let item of filteredSource$ | async"> </ng-container>

    <cdk-tree
      (contextmenu)="$event.preventDefault()"
      [dataSource]="dataSource"
      [treeControl]="treeControl"
      [trackBy]="trackBy$ | async"
    >
      <cdk-tree-node
        *cdkTreeNodeDef="let node; when: isElement"
        [cdkTreeNodeToggleRecursive]="true"
        [cdkTreeNodePaddingIndent]="10"
        cdkTreeNodePadding
        class="tree-node-row"
      >
        <div
          class="tree-node"
          [class.tree-node_selected]="idsIncludesNodeId(selectedNodesIds$ | async, node)"
          [class.tree-node_highlighted]="idsIncludesNodeId(highlightedNodesIds$ | async, node)"
        >
          <div class="tree-node__expansion-button" (click)="toggleExpansion(node)" cdkTreeNodeToggle>
            <ng-container
              [ngTemplateOutlet]="defaultExpansionButtonTemplate"
              [ngTemplateOutletContext]="{
                node: node,
                hasChild: false,
                isElement: true
              }"
            ></ng-container>
          </div>

          <ng-container
            [ngTemplateOutlet]="nodeTemplate$ | async"
            [ngTemplateOutletContext]="{
              node: node
            }"
          ></ng-container>
        </div>
      </cdk-tree-node>

      <cdk-tree-node
        *cdkTreeNodeDef="let node; when: hasNoChild"
        [cdkTreeNodeToggleRecursive]="true"
        [cdkTreeNodePaddingIndent]="10"
        cdkTreeNodePadding
        class="tree-node-row"
      >
        <div
          class="tree-node"
          [class.tree-node_selected]="idsIncludesNodeId(selectedNodesIds$ | async, node)"
          [class.tree-node_highlighted]="idsIncludesNodeId(highlightedNodesIds$ | async, node)"
        >
          <div class="tree-node__expansion-button" (click)="toggleExpansion(node)" cdkTreeNodeToggle>
            <ng-container
              [ngTemplateOutlet]="defaultExpansionButtonTemplate"
              [ngTemplateOutletContext]="{
                node: node,
                hasChild: false,
                isElement: false
              }"
            ></ng-container>
          </div>

          <ng-container
            [ngTemplateOutlet]="nodeTemplate$ | async"
            [ngTemplateOutletContext]="{
              node: node
            }"
          ></ng-container>
        </div>
      </cdk-tree-node>

      <cdk-tree-node
        *cdkTreeNodeDef="let node; when: hasChild"
        [cdkTreeNodeToggleRecursive]="true"
        [cdkTreeNodePaddingIndent]="10"
        cdkTreeNodePadding
        class="tree-node-row"
      >
        <div
          class="tree-node"
          [class.tree-node_selected]="idsIncludesNodeId(selectedNodesIds$ | async, node)"
          [class.tree-node_highlighted]="idsIncludesNodeId(highlightedNodesIds$ | async, node)"
        >
          <div class="tree-node__expansion-button" (click)="toggleExpansion(node)" cdkTreeNodeToggle>
            <ng-container
              [ngTemplateOutlet]="defaultExpansionButtonTemplate"
              [ngTemplateOutletContext]="{
                node: node,
                hasChild: true,
                isElement: false
              }"
            ></ng-container>
          </div>

          <ng-container
            [ngTemplateOutlet]="nodeTemplate$ | async"
            [ngTemplateOutletContext]="{
              node: node
            }"
          ></ng-container>
        </div>
      </cdk-tree-node>
    </cdk-tree>
  </cdk-virtual-scroll-viewport>

  <cdk-virtual-scroll-viewport #skeletonViewPort [itemSize]="treeItemSizePx" class="viewport viewport_skeleton">
    <pupa-skeleton>
      <pupa-skeleton-group *cdkVirtualFor="let item of filteredSource$ | async">
        <pupa-skeleton-line></pupa-skeleton-line>
      </pupa-skeleton-group>
    </pupa-skeleton>
  </cdk-virtual-scroll-viewport>
</section>

<ng-template #defaultTemplate let-node="node">
  {{ node?.name }}
</ng-template>

<ng-template #defaultExpansionButtonTemplate let-node="node" let-hasChild="hasChild">
  <button class="default-expansion-button" [disabled]="!hasChild">
    <ion-icon [name]="treeControl.isExpanded(node) ? 'ios-arrow-down' : 'ios-arrow-forward'"></ion-icon>
  </button>
</ng-template>
