<section class="tree">
  <cdk-virtual-scroll-viewport *ngIf="notNilManipulator$ | async" itemSize="28" class="viewport" #viewPort>
    <ng-container
      *cdkVirtualFor="let item of getRenderingAreaSkeleton(filteredSource$ | async, dataOrigin$ | async)"
    ></ng-container>

    <cdk-tree
      (contextmenu)="$event.preventDefault()"
      [dataSource]="dataSource$ | async"
      [treeControl]="treeControl$ | async"
      [trackBy]="trackBy$ | async"
    >
      <cdk-tree-node
        *cdkTreeNodeDef="let node; when: isElement"
        [cdkTreeNodeToggleRecursive]="true"
        [cdkTreeNodePaddingIndent]="10"
        cdkTreeNodePadding
        class="tree-node-row"
      >
        <div class="tree-node" [class.tree-node_selected]="nodeIsSelected(node, selectedNodesIds$ | async)">
          <div class="tree-node__expansion-button" (click)="toggleExpansion(node)" cdkTreeNodeToggle>
            <ng-container
              [ngTemplateOutlet]="defaultExpansionButtonTemplate"
              [ngTemplateOutletContext]="{
                node: node,
                hasChild: false,
                isElement: true
              }"
            ></ng-container>
          </div>

          <ng-container
            [ngTemplateOutlet]="nodeTemplate$ | async"
            [ngTemplateOutletContext]="{
              node: node
            }"
          ></ng-container>
        </div>
      </cdk-tree-node>

      <cdk-tree-node
        *cdkTreeNodeDef="let node; when: hasNoChild"
        [cdkTreeNodeToggleRecursive]="true"
        [cdkTreeNodePaddingIndent]="10"
        cdkTreeNodePadding
        class="tree-node-row"
      >
        <div class="tree-node" [class.tree-node_selected]="nodeIsSelected(node, selectedNodesIds$ | async)">
          <div class="tree-node__expansion-button" (click)="toggleExpansion(node)" cdkTreeNodeToggle>
            <ng-container
              [ngTemplateOutlet]="defaultExpansionButtonTemplate"
              [ngTemplateOutletContext]="{
                node: node,
                hasChild: false,
                isElement: false
              }"
            ></ng-container>
          </div>

          <ng-container
            [ngTemplateOutlet]="nodeTemplate$ | async"
            [ngTemplateOutletContext]="{
              node: node
            }"
          ></ng-container>
        </div>
      </cdk-tree-node>

      <cdk-tree-node
        *cdkTreeNodeDef="let node; when: hasChild"
        [cdkTreeNodeToggleRecursive]="true"
        [cdkTreeNodePaddingIndent]="10"
        cdkTreeNodePadding
        class="tree-node-row"
      >
        <div class="tree-node" [class.tree-node_selected]="nodeIsSelected(node, selectedNodesIds$ | async)">
          <div class="tree-node__expansion-button" (click)="toggleExpansion(node)" cdkTreeNodeToggle>
            <ng-container
              [ngTemplateOutlet]="defaultExpansionButtonTemplate"
              [ngTemplateOutletContext]="{
                node: node,
                hasChild: true,
                isElement: false
              }"
            ></ng-container>
          </div>

          <ng-container
            [ngTemplateOutlet]="nodeTemplate$ | async"
            [ngTemplateOutletContext]="{
              node: node
            }"
          ></ng-container>
        </div>
      </cdk-tree-node>
    </cdk-tree>
  </cdk-virtual-scroll-viewport>
</section>

<ng-template #defaultTemplate let-node="node">
  {{ node?.name }}
</ng-template>

<ng-template #defaultExpansionButtonTemplate let-node="node" let-hasChild="hasChild">
  <button class="default-expansion-button" [disabled]="!hasChild">
    <ion-icon [name]="(treeControl$ | async).isExpanded(node) ? 'ios-arrow-down' : 'ios-arrow-forward'"></ion-icon>
  </button>
</ng-template>
