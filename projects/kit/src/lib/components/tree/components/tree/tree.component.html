<section class="tree">
  <div class="tree__loader" *ngIf="isLoading$ | async">
    <pupa-spinner size="40px"></pupa-spinner>
  </div>

  <pupa-scrollable
    [invisibleScrollbars]="['vertical', 'horizontal']"
    class="skeleton-scrollable"
    innerPadding="2rem 3rem 3rem 2rem"
  >
    <cdk-virtual-scroll-viewport
      pupaScrollableContent
      #skeletonViewPort
      [itemSize]="treeItemSizePx"
      class="viewport viewport_skeleton"
    >
      <pupa-skeleton>
        <pupa-skeleton-group *cdkVirtualFor="let item of filteredSource$ | async">
          <pupa-tree-node-skeleton [level]="item.level"></pupa-tree-node-skeleton>
        </pupa-skeleton-group>
      </pupa-skeleton>
    </cdk-virtual-scroll-viewport>
  </pupa-scrollable>

  <pupa-scrollable innerPadding="2rem 3rem 3rem 2rem">
    <cdk-virtual-scroll-viewport pupaScrollableContent [itemSize]="treeItemSizePx" class="viewport" #viewPort>
      <ng-container *cdkVirtualFor="let item of filteredSource$ | async"> </ng-container>

      <cdk-tree [dataSource]="dataSource" [treeControl]="treeControl" [trackBy]="trackBy$ | async">
        <cdk-tree-node
          *cdkTreeNodeDef="let node; when: isElement"
          (mousedown)="mouseDown(node, $event)"
          (mouseenter)="mouseEnter(node)"
          (mouseleave)="mouseLeave()"
        >
          <ng-container
            [ngTemplateOutlet]="nodeTemplate || defaultTemplate"
            [ngTemplateOutletContext]="{
              node: node
            }"
          ></ng-container>
        </cdk-tree-node>

        <cdk-tree-node
          *cdkTreeNodeDef="let node; when: hasNoChild"
          (mousedown)="mouseDown(node, $event)"
          (mouseenter)="mouseEnter(node)"
          (mouseleave)="mouseLeave()"
        >
          <ng-container
            [ngTemplateOutlet]="nodeTemplate || defaultTemplate"
            [ngTemplateOutletContext]="{
              node: node
            }"
          ></ng-container>
        </cdk-tree-node>

        <cdk-tree-node
          *cdkTreeNodeDef="let node; when: hasChild"
          (mousedown)="mouseDown(node, $event)"
          (mouseenter)="mouseEnter(node)"
          (mouseleave)="mouseLeave()"
        >
          <ng-container
            [ngTemplateOutlet]="nodeTemplate || defaultTemplate"
            [ngTemplateOutletContext]="{
              node: node
            }"
          ></ng-container>
        </cdk-tree-node>
      </cdk-tree>
    </cdk-virtual-scroll-viewport>
  </pupa-scrollable>

  <div *ngIf="draggingHasStarted" class="draggable" #draggable>
    <ng-container
      [ngTemplateOutlet]="nodeTemplate || defaultTemplate"
      [ngTemplateOutletContext]="{
        node: draggableNode
      }"
    ></ng-container>
  </div>
</section>

<ng-template #defaultTemplate let-node="node">
  <pupa-tree-node [treeNodeProperties]="getTreeNodeProperties(node) | async">{{ node?.name }}</pupa-tree-node>
</ng-template>
