#! /bin/bash

set -e

IMAGES_FILE=${IMAGES_FILE:-images.list}
IMAGES=`cat ${IMAGES_FILE}`
DOCKER_REGISTRY=${DOCKER_REGISTRY:-docker.meistersoft.ru}
DOCKER_REGISTRY_ELASTIC=${DOCKER_REGISTRY_ELASTIC:-docker.elastic.co}

sed -i 's/'${DOCKER_REGISTRY}'\///g' ${IMAGES_FILE}
sed -i 's/'$DOCKER_REGISTRY_ELASTIC'\///g' ${IMAGES_FILE}

IMAGES_SCAN=`sed 's/^/'$DOCKER_REGISTRY'\/vuln\//' ${IMAGES_FILE}`
IMAGES_TAG=$(paste <(echo "$IMAGES") <(echo "$IMAGES_SCAN"))
echo ${IMAGES_TAG} | xargs -n 2 docker tag
echo ${IMAGES_SCAN} | xargs -n 1 docker push